<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SJ Auto - Premium Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { sjgold: '#FFD700' },
          boxShadow: {
            gold: '0 10px 25px -5px rgba(255,215,0,0.15), 0 8px 10px -6px rgba(255,215,0,0.08)'
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold">
  <!-- Top Navigation -->
  <header class="sticky top-0 z-10 backdrop-blur bg-black/70 border-b border-sjgold/20">
    <nav class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-6 text-sm">
        <a href="index.html" class="opacity-80 hover:opacity-100">Back to Home</a>
        <a href="sale.html" class="opacity-60 hover:opacity-100">Sell</a>
      </div>
      <div class="text-xs opacity-70">SJ Auto — Premium Inventory</div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 md:py-10">
    <h1 class="text-2xl md:text-3xl font-bold tracking-wide mb-6">Available Cars</h1>
    <div id="car-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUD   = 'duwckagtg';

    const fmtPrice   = v => v ? String(v).replace(/(\d)(?=(\d{3})+$)/g, '$1,') : '';
    const fmtMileage = v => v ? `${v} km` : '';

    // 根据 VIN 拉 Cloudinary，并把 <img> 的 src 设置为“带版本号”的 URL
    async function fillImageByVin(vin, imgEl) {
      try {
        const r = await fetch(`${BACKEND}/cloudinary-search?vin=${encodeURIComponent(vin)}`);
        const data = await r.json();
        const items = Array.isArray(data.resources) ? data.resources : [];

        // 优先 VINmain，然后 VIN1、VIN01…，再其他
        const main = items.find(x => /main$/i.test(x.public_id))
                  || items.find(x => /\d+$/.test(x.public_id))
                  || items[0];

        if (main) {
          // 版本段 + 自适应格式/质量
          const url = `https://res.cloudinary.com/${CLOUD}/image/upload/f_auto,q_auto/v${main.version}/${main.public_id}`;
          imgEl.src = url;
        } else {
          imgEl.src = 'https://placehold.co/800x600/111111/FFD700?text=No+Image';
        }
      } catch (e) {
        console.error('image fetch failed for', vin, e);
        imgEl.src = 'https://placehold.co/800x600/111111/FFD700?text=No+Image';
      }
    }

    async function loadCars() {
      try {
        const res = await fetch(`${BACKEND}/sheet1`);
        const json = await res.json();
        const rows    = json.values || [];
        if (!rows.length) return;

        const headers = rows[0] || [];
        const body    = rows.slice(1);

        const vinIdx     = headers.indexOf('VIN');
        const statusIdx  = headers.indexOf('Status');
        const yearIdx    = headers.indexOf('Year');
        const makeIdx    = headers.indexOf('Make');
        const modelIdx   = headers.indexOf('Model');
        const mileageIdx = headers.indexOf('Mileage');
        const colorIdx   = headers.indexOf('Color');
        const priceIdx   = headers.indexOf('Price');

        const container = document.getElementById('car-list');
        container.innerHTML = '';

        body.forEach(row => {
          const status = (row?.[statusIdx] || '').toLowerCase();
          if (status === 'sold' || status === 'deleted') return;

          const vin     = row?.[vinIdx] || '';
          const year    = row?.[yearIdx] || '';
          const make    = row?.[makeIdx] || '';
          const model   = row?.[modelIdx] || '';
          const color   = row?.[colorIdx] || '';
          const price   = row?.[priceIdx] || '';
          const mileage = row?.[mileageIdx] || '';

          // Card
          const card = document.createElement('article');
          card.className = `
            group bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/15 shadow-gold
            overflow-hidden flex flex-col hover:ring-sjgold/30 transition
          `;

          // Top image
          const imgWrap = document.createElement('div');
          imgWrap.className = 'w-full h-44 sm:h-48 md:h-52 bg-neutral-900 overflow-hidden';
          const img = document.createElement('img');
          img.className = 'w-full h-full object-cover group-hover:scale-[1.02] transition';
          img.alt = `${make} ${model}`;
          img.loading = 'lazy';
          img.decoding = 'async';
          img.src = 'https://placehold.co/800x600/111111/FFD700?text=Loading...';
          img.onerror = () => { img.src = 'https://placehold.co/800x600/111111/FFD700?text=No+Image'; };
          imgWrap.appendChild(img);

          // Info section（预留底部按钮空间）
          const bodyBox = document.createElement('div');
          bodyBox.className = 'relative p-4 pb-16';

          // Title（不截断不被覆盖）
          const title = document.createElement('h3');
          title.className = 'text-base md:text-lg font-semibold leading-snug';
          title.textContent = `${year} ${make} ${model}`.trim();

          // Price
          const priceEl = document.createElement('div');
          priceEl.className = 'mt-1 text-lg md:text-xl font-bold text-sjgold/95';
          priceEl.textContent = price ? `CAD $${fmtPrice(price)}` : 'Price on Request';

          // Color / Mileage
          const meta = document.createElement('div');
          meta.className = 'mt-2 text-sm text-sjgold/80 space-y-1';
          if (color)   meta.insertAdjacentHTML('beforeend', `<p>Color: ${color}</p>`);
          if (mileage) meta.insertAdjacentHTML('beforeend', `<p>Mileage: ${fmtMileage(mileage)}</p>`);

          // View details button（右下角固定）
          const btn = document.createElement('button');
          btn.className = `
            absolute right-4 bottom-4 inline-flex items-center justify-center
            h-10 px-4 rounded-xl bg-sjgold text-black font-semibold text-sm
            whitespace-nowrap hover:brightness-95 active:brightness-90
            ring-1 ring-sjgold/30 transition
          `;
          btn.textContent = 'View Details';
          btn.onclick = () => window.location.href = `detail.html?vin=${encodeURIComponent(vin)}`;

          bodyBox.appendChild(title);
          bodyBox.appendChild(priceEl);
          bodyBox.appendChild(meta);
          bodyBox.appendChild(btn);

          card.appendChild(imgWrap);
          card.appendChild(bodyBox);
          container.appendChild(card);

          // 异步填充“带版本”的主图，避免缓存
          if (vin) fillImageByVin(vin, img);
        });
      } catch (err) {
        console.error('Failed to load inventory:', err);
        const container = document.getElementById('car-list');
        const tip = document.createElement('div');
        tip.className = 'col-span-full text-center py-12 opacity-80';
        tip.textContent = 'Failed to load vehicles. Please try again later.';
        container.appendChild(tip);
      }
    }

    loadCars();
  </script>
</body>
</html>
