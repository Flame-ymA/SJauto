<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SJ Auto 优质车源</title>
  <!-- Tailwind（开发/预览用；生产建议改本地构建） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { sjgold: '#FFD700' },
          boxShadow: {
            'gold': '0 10px 25px -5px rgba(255,215,0,0.15), 0 8px 10px -6px rgba(255,215,0,0.08)'
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold">
  <!-- 顶部导航 -->
  <header class="sticky top-0 z-10 backdrop-blur bg-black/70 border-b border-sjgold/20">
    <nav class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-6 text-sm">
        <a href="index.html" class="opacity-80 hover:opacity-100">返回首页</a>
        <a href="sale.html" class="opacity-60 hover:opacity-100">卖车</a>
        <a href="#" class="opacity-60 hover:opacity-100">租车</a>
      </div>
      <div class="text-xs opacity-70">SJ Auto — 优质车源</div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 md:py-10">
    <h1 class="text-2xl md:text-3xl font-bold tracking-wide mb-6">在售车源</h1>

    <!-- 车卡列表 -->
    <div id="car-list"
         class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
      <!-- JS 动态填充 -->
    </div>

    <!-- 加载失败兜底 -->
    <div id="errorTip" class="hidden col-span-full text-center py-12 opacity-80">车源加载失败，请稍后重试。</div>
  </main>

  <script>
    const SHEET_ID = '1ZWlrgY0j4AHPkvJ6MQn7-YAz-zxqnDb_BVtT-d2YGcs';
    const API_KEY  = 'AIzaSyBdYLXN_nYf9S-5SMZ8FG1u89XZgpa1mjc';
    const CLOUD    = 'duwckagtg';

    // 简单格式化：价格/里程
    const fmtPrice   = v => v ? String(v).replace(/(\d)(?=(\d{3})+$)/g, '$1,') : '';
    const fmtMileage = v => v ? `${v} km` : '';

    // 占位图
    const FALLBACK = 'https://placehold.co/800x600/111111/FFD700?text=No+Image';

    // 依次尝试多种 Cloudinary 路径，提升主图命中率
    function buildImageCandidates(vin) {
      return [
        `https://res.cloudinary.com/${CLOUD}/image/upload/${vin}/${vin}main`,     // 无后缀，走 Cloudinary 自动格式
        `https://res.cloudinary.com/${CLOUD}/image/upload/${vin}/${vin}main.jpg`,
        `https://res.cloudinary.com/${CLOUD}/image/upload/${vin}/${vin}main.png`,
        `https://res.cloudinary.com/${CLOUD}/image/upload/${vin}/${vin}1.jpg`,
      ];
    }

    // 懒加载工具：进入可视区时真正加载图片
    const io = ('IntersectionObserver' in window)
      ? new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              const candidates = img.dataset.candidates ? img.dataset.candidates.split('|') : [];
              tryLoadImage(img, candidates);
              io.unobserve(img);
            }
          });
        }, { rootMargin: '200px' })
      : null;

    function tryLoadImage(img, candidates) {
      if (!candidates || candidates.length === 0) {
        img.src = FALLBACK;
        return;
      }
      const url = candidates.shift();
      // 临时 Image 对象测试加载是否成功
      const probe = new Image();
      probe.onload = () => { img.src = url; };
      probe.onerror = () => { tryLoadImage(img, candidates); };
      probe.src = url;
    }

    function createCarCard(record) {
      const { vin, year, make, model, color, price, mile } = record;

      const card = document.createElement('article');
      card.className = `
        group bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/15 shadow-gold
        overflow-hidden flex flex-col hover:ring-sjgold/30 transition
      `;

      // 图：固定高度，object-cover
      const imgWrap = document.createElement('div');
      imgWrap.className = 'w-full h-48 sm:h-52 md:h-56 bg-neutral-900 overflow-hidden';
      const img = document.createElement('img');
      img.className = 'w-full h-full object-cover group-hover:scale-[1.02] transition';
      img.alt = `${make} ${model}`;
      img.src = FALLBACK; // 先占位
      img.loading = 'lazy';
      img.decoding = 'async';
      img.dataset.candidates = buildImageCandidates(vin).join('|');
      imgWrap.appendChild(img);
      if (io) io.observe(img); else tryLoadImage(img, img.dataset.candidates.split('|'));

      // 文字
      const body = document.createElement('div');
      body.className = 'p-4 flex-1 flex flex-direction-col';

      const title = document.createElement('h3');
      title.className = 'text-base md:text-lg font-semibold mb-1 line-clamp-1';
      title.textContent = `${year || ''} ${make || ''} ${model || ''}`.trim();

      const priceEl = document.createElement('div');
      priceEl.className = 'text-lg md:text-xl font-bold text-sjgold/95 mt-1';
      priceEl.textContent = price ? `CAD $${fmtPrice(price)}` : '价格面议';

      const meta = document.createElement('div');
      meta.className = 'mt-2 text-sm space-y-1 text-sjgold/80';
      const metaLines = [
        color ? `颜色：${color}` : '',
        mile  ? `里程：${fmtMileage(mile)}` : ''
      ].filter(Boolean);
      meta.innerHTML = metaLines.map(t => `<p>${t}</p>`).join('');

      const btn = document.createElement('button');
      btn.className = `
        mt-4 inline-flex items-center justify-center px-3 py-2 rounded-xl
        bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90
        ring-1 ring-sjgold/30 shadow-gold transition
      `;
      btn.textContent = '查看详细';
      btn.onclick = () => window.location.href = `detail.html?vin=${encodeURIComponent(vin)}`;

      body.appendChild(title);
      body.appendChild(priceEl);
      body.appendChild(meta);
      body.appendChild(btn);

      card.appendChild(imgWrap);
      card.appendChild(body);
      return card;
    }

    async function loadCars() {
      try {
        const res  = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1?key=${API_KEY}`);
        const data = await res.json();
        const rows    = data.values || [];
        const headers = rows[0] || [];

        const vinIdx     = headers.indexOf('VIN');
        const statusIdx  = headers.indexOf('Status');
        const yearIdx    = headers.indexOf('Year');
        const makeIdx    = headers.indexOf('Make');
        const modelIdx   = headers.indexOf('Model');
        const mileageIdx = headers.indexOf('Mileage');
        const colorIdx   = headers.indexOf('Color');
        const priceIdx   = headers.indexOf('Price');

        const container = document.getElementById('car-list');

        rows.slice(1).forEach(row => {
          const status = String(row[statusIdx] || '').toLowerCase();
          if (status === 'sold' || status === 'deleted') return;

          const record = {
            vin:   row[vinIdx],
            year:  row[yearIdx]   || '',
            make:  row[makeIdx]   || '',
            model: row[modelIdx]  || '',
            color: row[colorIdx]  || '',
            price: row[priceIdx]  || '',
            mile:  row[mileageIdx]|| ''
          };

          // 没 VIN 的数据不渲染
          if (!record.vin) return;

          container.appendChild(createCarCard(record));
        });

      } catch (err) {
        console.error('加载表格失败:', err);
        document.getElementById('errorTip').classList.remove('hidden');
      }
    }

    loadCars();
  </script>
</body>
</html>
