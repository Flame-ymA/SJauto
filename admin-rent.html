<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>SJ Auto · 租赁车辆管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { sjgold: '#FFD700' },
          boxShadow: {
            glow: '0 0 0 1px rgba(255,215,0,0.25), 0 10px 25px -5px rgba(0,0,0,0.5)'
          }
        }
      }
    }
  </script>
  <style>
    .app-header { height: 64px; }
  </style>
</head>
<body class="min-h-screen bg-black text-sjgold">

  <!-- 顶部 -->
  <header class="app-header sticky top-0 z-20 bg-zinc-950/80 backdrop-blur border-b border-sjgold/30">
    <div class="max-w-6xl mx-auto h-full px-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold tracking-wide">SJ Auto · Admin · 租赁车辆</h1>
      <a href="admin.html"
         class="px-4 py-2 rounded-xl border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition">
        返回库存管理
      </a>
    </div>
  </header>

  <!-- 主体 -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="rounded-2xl border border-sjgold/30 bg-zinc-950/60 shadow-glow overflow-hidden">
      <div class="px-5 py-4 border-b border-sjgold/20 flex items-center justify-between">
        <h2 class="text-lg font-semibold">租赁列表（Sheet3）</h2>
        <span id="rowCount" class="text-xs text-sjgold/70"></span>
      </div>

      <div class="overflow-auto">
        <table class="min-w-full text-sm table-fixed">
          <colgroup>
            <col style="width:10rem" />  <!-- StockNumber -->
            <col style="width:5.5rem" /> <!-- Year -->
            <col style="width:7rem" />   <!-- Brand -->
            <col style="width:8rem" />   <!-- Model -->
            <col style="width:8rem" />   <!-- Trim -->
            <col style="width:8rem" />   <!-- Price/day -->
            <col style="width:8rem" />   <!-- Price/Week -->
            <col style="width:8rem" />   <!-- Price/Month -->
            <col style="width:8rem" />   <!-- Insurance -->
            <col style="width:7rem" />   <!-- Status -->
            <col style="width:9rem"  />  <!-- OverKmFee（可选） -->
            <col style="width:14rem" />  <!-- 操作 -->
          </colgroup>

          <!-- 表头紧贴容器上沿 -->
          <thead class="bg-zinc-900 sticky z-10 border-b border-sjgold/20" style="top:0;">
            <tr class="text-left">
              <th class="px-4 py-3 font-semibold">StockNumber</th>
              <th class="px-4 py-3 font-semibold">Year</th>
              <th class="px-4 py-3 font-semibold">Brand</th>
              <th class="px-4 py-3 font-semibold">Model</th>
              <th class="px-4 py-3 font-semibold">Trim</th>
              <th class="px-4 py-3 font-semibold">Price/Day</th>
              <th class="px-4 py-3 font-semibold">Price/Week</th>
              <th class="px-4 py-3 font-semibold">Price/Month</th>
              <th class="px-4 py-3 font-semibold">Insurance</th>
              <th class="px-4 py-3 font-semibold">Status</th>
              <th class="px-4 py-3 font-semibold">OverKmFee</th>
              <th class="px-4 py-3 font-semibold text-center">操作</th>
            </tr>
          </thead>

          <tbody id="tableBody" class="divide-y divide-sjgold/10"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    // 规范化表头：小写 + 去非字母
    const norm = s => String(s||'').toLowerCase().replace(/[^a-z]/g,'');

    async function loadSheet3() {
      try {
        const res = await fetch(`${BACKEND}/sheet3`);
        const data = await res.json();
        if (!data.ok) throw new Error('sheet3 read failed');

        const tbody = document.getElementById('tableBody');
        const count = document.getElementById('rowCount');
        tbody.innerHTML = '';

        const values = data.values || [];
        if (!values.length) { count.textContent = '共 0 条'; return; }

        // 判断首行是否表头
        const headRow = values[0] || [];
        const headSet  = new Set(headRow.map(norm));
        const hints = ['stocknumber','year','brand','model','trim','priceday','priceweek','pricemonth','insurance','status','overkmfee'];
        const hasHeader = hints.some(h => headSet.has(h));

        const rows = hasHeader ? values.slice(1) : values;
        count.textContent = `共 ${rows.length} 条`;

        // 列索引（兼容不同写法）
        const idx = (name, fallback = -1) => {
          const target = norm(name);
          const pos = headRow.findIndex(h => norm(h) === target);
          return pos === -1 ? fallback : pos;
        };

        const cStock = idx('StockNumber', 0);
        const cYear  = idx('Year', 1);
        const cBrand = idx('Brand', 2);
        const cModel = idx('Model', 3);
        const cTrim  = idx('Trim', 4);
        const cDay   = idx('Price/Day', 5);
        const cWeek  = idx('Price/Week', 6);
        const cMonth = idx('Price/Month', 7);
        const cIns   = idx('Insurance', 8);
        const cStatus= idx('Status', 9);
        const cFee   = headRow.findIndex(h => norm(h) === 'overkmfee'); // 可能不存在

        rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-zinc-900/60 transition';

          const td = (text) => {
            const el = document.createElement('td');
            el.className = 'px-4 py-3 truncate';
            el.textContent = text ?? '';
            return el;
          };

          const stock = row[cStock] || '';

          tr.appendChild(td(row[cStock]));
          tr.appendChild(td(row[cYear]));
          tr.appendChild(td(row[cBrand]));
          tr.appendChild(td(row[cModel]));
          tr.appendChild(td(row[cTrim]));
          tr.appendChild(td(row[cDay]));
          tr.appendChild(td(row[cWeek]));
          tr.appendChild(td(row[cMonth]));
          tr.appendChild(td(row[cIns]));
          tr.appendChild(td(row[cStatus]));

          // OverKmFee（可编辑）
          const feeTd = document.createElement('td');
          feeTd.className = 'px-4 py-3';
          if (cFee !== -1) {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = row[cFee] ?? '';
            input.placeholder = '如 0.30';
            input.className = 'w-28 px-2 py-1 rounded-md bg-black/40 border border-sjgold/30 focus:outline-none focus:ring-2 focus:ring-yellow-500';
            input.dataset.stock = stock;
            feeTd.appendChild(input);
          } else {
            feeTd.textContent = '—';
          }
          tr.appendChild(feeTd);

          // 操作列：Upload / 预览 / 保存费率
          const ops = document.createElement('td');
          ops.className = 'px-4 py-3';
          const wrap = document.createElement('div');
          wrap.className = 'flex flex-wrap gap-2 justify-center';

          const btnUp = document.createElement('button');
          btnUp.className = 'px-3 py-1.5 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90 transition';
          btnUp.textContent = 'Upload';
          btnUp.onclick = () => uploadImageSigned(stock);
          wrap.appendChild(btnUp);

          const btnView = document.createElement('button');
          btnView.className = 'px-3 py-1.5 rounded-lg border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition';
          btnView.textContent = '预览';
          btnView.onclick = () => window.open(`rent-detail.html?stock=${encodeURIComponent(stock)}`, '_blank');
          wrap.appendChild(btnView);

          if (cFee !== -1) {
            const btnSave = document.createElement('button');
            btnSave.className = 'px-3 py-1.5 rounded-lg border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition';
            btnSave.textContent = '保存费率';
            btnSave.onclick = async () => {
              const val = feeTd.querySelector('input')?.value ?? '';
              try {
                const r = await fetch(`${BACKEND}/update-rent-fee`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ stock, fee: val })
                });
                const js = await r.json();
                if (!r.ok || !js.success) throw new Error(js.error || 'update failed');
                alert('已更新 OverKmFee');
              } catch (e) {
                alert('更新失败：' + e.message);
              }
            };
            wrap.appendChild(btnSave);
          }

          ops.appendChild(wrap);
          tr.appendChild(ops);

          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('读取表格失败：' + err.message);
      }
    }

    // Cloudinary 签名上传：第一张 stockmain，其余 stock1、stock2…
    async function uploadImageSigned(stock) {
      if (!stock) { alert('该行没有 StockNumber，无法上传图片'); return; }
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;

      input.onchange = async () => {
        const files = input.files;
        if (!files || !files.length) return;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const filename = i === 0 ? `${stock}main` : `${stock}${i}`;
          const publicId = `${stock}/${filename}`;

          try {
            const signRes = await fetch(`${BACKEND}/get-signature`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ public_id: publicId })
            });
            const { signature, timestamp, apiKey } = await signRes.json();

            const formData = new FormData();
            formData.append('file', file);
            formData.append('api_key', apiKey);
            formData.append('timestamp', timestamp);
            formData.append('signature', signature);
            formData.append('public_id', publicId);

            const uploadRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
              method: 'POST',
              body: formData
            });
            const result = await uploadRes.json();
            if (!result.secure_url) throw new Error(result.error?.message || 'upload failed');
          } catch (err) {
            console.error('上传异常:', err);
            alert('上传异常：' + err.message);
            return;
          }
        }

        alert(`✅ 上传完成，共上传 ${files.length} 张图`);
      };

      input.click();
    }

    // 初始化
    loadSheet3();
  </script>
</body>
</html>
