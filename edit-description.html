<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>编辑车辆描述</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --sj:#FFD700; }
    body {
      background-color: #000;
      color: var(--sj);
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    .wrap {
      max-width: 880px;
      margin: 0 auto;
    }
    h1 { text-align: center; margin: 0 0 10px; }
    .sub { text-align:center; color:#d4b400; font-size:13px; opacity:.9; }
    .badge {
      display:inline-block; padding:4px 8px; border:1px solid var(--sj);
      border-radius:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      letter-spacing:.5px; margin: 10px auto; text-align:center;
    }
    textarea {
      width: 100%;
      min-height: 320px;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--sj);
      background-color: #111;
      color: var(--sj);
      border-radius: 10px;
      outline: none;
      box-sizing: border-box;
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .row .left { font-size: 12px; color:#d4b400; opacity:.9; }
    button {
      background-color: var(--sj);
      color: #000;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      margin-top: 16px;
      cursor: pointer;
      border-radius: 10px;
      transition: filter .15s ease;
    }
    button:hover { filter: brightness(0.95); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .notice { margin-top: 10px; font-size: 13px; color: #d4b400; }
    .error  { color: #ff6b6b; }
    .ok     { color: #7CFC00; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>编辑车辆描述</h1>
    <div id="vinBadge" class="badge"></div>
    <p class="sub">从后台读取并保存到 Google Sheet（经由后端）</p>

    <textarea id="description" placeholder="输入车辆描述..."></textarea>

    <div class="row">
      <div id="counter" class="left">0 字</div>
      <div>
        <button id="btnSave" onclick="saveDescription()">保存描述</button>
      </div>
    </div>

    <div id="msg" class="notice"></div>
  </div>

  <script>
    // ===== 配置 =====
    const BACKEND = 'https://flameauto-write.onrender.com';
    // 如果你在后端加了简单的 Bearer 鉴权，这里放一个只读/只写 token：
    // const AUTH = 'Bearer YOUR_TOKEN';
    const AUTH = null; // 目前默认不加鉴权头

    const vin = new URLSearchParams(window.location.search).get('vin');
    const vinBadge = document.getElementById('vinBadge');
    const descEl   = document.getElementById('description');
    const btnSave  = document.getElementById('btnSave');
    const msgEl    = document.getElementById('msg');
    const counter  = document.getElementById('counter');

    if (!vin) {
      vinBadge.textContent = 'VIN 缺失';
      msg('未提供 VIN 参数，无法加载或保存描述。', 'error');
      btnSave.disabled = true;
    } else {
      vinBadge.textContent = `VIN: ${vin}`;
      loadCurrent();
    }

    // 字数统计
    descEl.addEventListener('input', () => {
      counter.textContent = (descEl.value || '').length + ' 字';
    });

    // 从后端读 Sheet1（安全：前端不再暴露 Google API Key）
    async function loadCurrent() {
      try {
        msg('正在加载描述...', null);
        const res = await fetch(`${BACKEND}/sheet1`, {
          headers: Object.assign(
            { 'Content-Type': 'application/json' },
            AUTH ? { 'Authorization': AUTH } : {}
          )
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || '加载失败');

        const values = data.values || [];
        const headers = values[0] || [];
        const vinIdx = headers.indexOf('VIN');
        const detailIdx = headers.indexOf('Detail');

        if (vinIdx === -1 || detailIdx === -1) {
          msg('表头缺少 VIN 或 Detail 列。', 'error');
          return;
        }

        const row = values.find((r, i) => i > 0 && r[vinIdx] === vin);
        if (row && row[detailIdx]) {
          descEl.value = row[detailIdx];
          counter.textContent = (descEl.value || '').length + ' 字';
          msg('已加载当前描述。', 'ok');
        } else {
          descEl.value = '';
          counter.textContent = '0 字';
          msg('没有已有描述，可直接编辑后保存。', null);
        }
      } catch (e) {
        console.error(e);
        msg('加载描述失败：' + e.message, 'error');
      }
    }

    // 保存到后端（后端写入 Sheet1 的 Detail）
    async function saveDescription() {
      const detail = (descEl.value || '').trim();
      if (!detail) {
        msg('描述不能为空。', 'error');
        return;
      }
      if (!vin) return;

      try {
        btnSave.disabled = true;
        msg('正在保存...', null);

        const res = await fetch(`${BACKEND}/update-detail`, {
          method: 'POST',
          headers: Object.assign(
            { 'Content-Type': 'application/json' },
            AUTH ? { 'Authorization': AUTH } : {}
          ),
          body: JSON.stringify({ vin, detail })
        });
        const data = await res.json();

        if (data && data.success) {
          msg('✅ 描述已保存。', 'ok');
        } else {
          throw new Error(data?.error || '保存失败');
        }
      } catch (e) {
        console.error(e);
        msg('❌ 保存失败：' + e.message, 'error');
      } finally {
        btnSave.disabled = false;
      }
    }

    function msg(text, type) {
      msgEl.textContent = text || '';
      msgEl.className = 'notice' + (type ? ' ' + type : '');
    }
  </script>
</body>
</html>
