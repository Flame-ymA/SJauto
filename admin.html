<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>SJ Auto Inventory Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Tailwind CDNï¼ˆå¼€å‘/é¢„è§ˆç”¨ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { sjgold: '#FFD700' },
          boxShadow: {
            glow: '0 0 0 1px rgba(255,215,0,0.25), 0 10px 25px -5px rgba(0,0,0,0.5)'
          }
        }
      }
    }
  </script>
  <style>
    /* å›ºå®š header é«˜åº¦ï¼Œæ–¹ä¾¿ sticky è¡¨å¤´å®šä½ */
    .app-header { height: 64px; }
  </style>
</head>
<body class="min-h-screen bg-black text-sjgold">

  <!-- é¡¶éƒ¨æ ï¼ˆå›ºå®šé«˜åº¦ 64pxï¼‰ -->
  <header class="app-header sticky top-0 z-20 bg-zinc-950/80 backdrop-blur border-b border-sjgold/30">
    <div class="max-w-6xl mx-auto h-full px-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold tracking-wide">SJ Auto Â· Admin</h1>
      <div class="flex items-center gap-3">
        <!-- æŸ¥çœ‹å–è½¦å›¾ç‰‡ -->
        <button onclick="window.location.href='admin-review.html'"
                class="px-4 py-2 rounded-xl border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition">
          æŸ¥çœ‹å–è½¦å›¾ç‰‡
        </button>

        <!-- é€‰æ‹©å¹¶ä¸Šä¼  Excel -->
        <label class="inline-flex items-center gap-3 px-3 py-2 rounded-xl border border-sjgold/30 hover:border-sjgold/60 transition">
          <input id="excelFile" type="file" class="hidden" />
          <span class="text-sm">é€‰æ‹© Excel</span>
        </label>
        <button onclick="uploadExcel()" class="px-4 py-2 rounded-xl bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90 shadow-glow transition">
          ä¸Šä¼ å¹¶åŠ è½½è¡¨æ ¼
        </button>
      </div>
    </div>
  </header>

  <!-- ä¸»ä½“ -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="rounded-2xl border border-sjgold/30 bg-zinc-950/60 shadow-glow overflow-hidden">
      <div class="px-5 py-4 border-b border-sjgold/20 flex items-center justify-between">
        <h2 class="text-lg font-semibold">åº“å­˜åˆ—è¡¨</h2>
        <span id="rowCount" class="text-xs text-sjgold/70"></span>
      </div>

      <!-- å¯æ»šåŠ¨å®¹å™¨ -->
      <div class="overflow-auto">
        <!-- å›ºå®šåˆ—å®½ï¼šcolgroup + table-fixed -->
        <table class="min-w-full text-sm table-fixed">
          <colgroup>
            <col style="width:5.5rem" />  <!-- Year -->
            <col style="width:6.5rem" />  <!-- Make -->
            <col style="width:8rem" />    <!-- Model -->
            <col style="width:8rem" />    <!-- Mileage -->
            <col style="width:9rem" />    <!-- Color -->
            <col style="width:8rem" />    <!-- Price -->
            <col style="width:8rem" />    <!-- Accident -->
            <col style="width:6rem" />    <!-- Status -->
            <col style="width:14rem" />   <!-- VIN -->
            <col style="width:12rem" />   <!-- æ“ä½œ -->
          </colgroup>

          <!-- sticky è¡¨å¤´ï¼štop è®¾ä¸º header çš„é«˜åº¦ 64px -->
          <thead class="bg-zinc-900 sticky z-10 border-b border-sjgold/20" style="top:64px;">
            <tr class="text-left">
              <th class="px-4 py-3 font-semibold">Year</th>
              <th class="px-4 py-3 font-semibold">Make</th>
              <th class="px-4 py-3 font-semibold">Model</th>
              <th class="px-4 py-3 font-semibold">Mileage</th>
              <th class="px-4 py-3 font-semibold">Color</th>
              <th class="px-4 py-3 font-semibold">Price (CAD)</th>
              <th class="px-4 py-3 font-semibold">Accident</th>
              <th class="px-4 py-3 font-semibold">Status</th>
              <th class="px-4 py-3 font-semibold">VIN</th>
              <th class="px-4 py-3 font-semibold text-center">æ“ä½œ</th>
            </tr>
          </thead>

          <tbody id="tableBody" class="divide-y divide-sjgold/10">
            <!-- è¡Œæ•°æ®ç”± JS æ³¨å…¥ -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    // åŠ è½½è¡¨æ ¼ï¼ˆä»åç«¯ sheet1 è¯»å–ï¼‰
async function loadSheet() {
  try {
    const res = await fetch(`${BACKEND}/sheet1`);
    const data = await res.json();

    if (!data.ok) {
      console.error('Sheet1 è¯»å–å¤±è´¥ï¼š', data);
      alert('è¯»å–è¡¨æ ¼å¤±è´¥ï¼Œç¨åé‡è¯•ã€‚');
      return;
    }

    const tbody = document.getElementById('tableBody');
    const count = document.getElementById('rowCount');
    tbody.innerHTML = '';

    const values = data.values || [];
    if (!values.length) {
      count.textContent = 'å…± 0 æ¡';
      return;
    }

    // ğŸ‘‡ ä»…å½“ç¬¬ä¸€è¡Œæ˜æ˜¾æ˜¯è¡¨å¤´æ—¶æ‰è·³è¿‡
    const first = values[0].map(v => String(v || '').trim().toLowerCase());
    const looksLikeHeader =
      first.includes('vin') ||
      first.includes('year') ||
      first.includes('make') ||
      first.includes('model');

    const rows = looksLikeHeader ? values.slice(1) : values;
    count.textContent = `å…± ${rows.length} æ¡`;

    rows.forEach((row) => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-zinc-900/60 transition';

      // ä»…æ˜¾ç¤º 0~8 åˆ—ï¼ˆä¸æ˜¾ç¤º Detailï¼‰
      const displayCols = [0,1,2,3,4,5,6,7,8];
      displayCols.forEach(colIndex => {
        const td = document.createElement('td');
        td.className = 'px-4 py-3 truncate';
        td.textContent = (row[colIndex] ?? '');
        tr.appendChild(td);
      });

      const vin = row[8] || '';
      const tdOps = document.createElement('td');
      tdOps.className = 'px-4 py-3';

      const wrap = document.createElement('div');
      wrap.className = 'flex justify-center gap-2';

      const uploadBtn = document.createElement('button');
      uploadBtn.className = 'w-24 px-3 py-1.5 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90 transition';
      uploadBtn.textContent = 'Upload';
      uploadBtn.onclick = () => uploadImageSigned(vin);
      wrap.appendChild(uploadBtn);

      const editBtn = document.createElement('button');
      editBtn.className = 'w-24 px-3 py-1.5 rounded-lg border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition';
      editBtn.textContent = 'ç¼–è¾‘æè¿°';
      editBtn.onclick = () => window.open(`edit-description.html?vin=${encodeURIComponent(vin)}`, '_blank');
      wrap.appendChild(editBtn);

      tdOps.appendChild(wrap);
      tr.appendChild(tdOps);
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error(err);
    alert('è¯»å–è¡¨æ ¼å¤±è´¥ï¼š' + err.message);
  }
}

    // ä¸Šä¼  Excelï¼ˆåç«¯å¢é‡å†™å…¥ï¼‰
    async function uploadExcel() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      if (!file) return alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(`${BACKEND}/upload`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          console.error('ä¸Šä¼ å¤±è´¥ï¼š', data);
          alert('ä¸Šä¼ å¤±è´¥');
          return;
        }
        alert('ä¸Šä¼ æˆåŠŸ');
        loadSheet();
      } catch (err) {
        console.error(err);
        alert('ä¸Šä¼ å¤±è´¥ï¼š' + err.message);
      }
    }

    // Cloudinary ç­¾åä¸Šä¼ ï¼šç¬¬ä¸€å¼  vinmainï¼Œå…¶ä½™ vin1ã€vin2â€¦
    async function uploadImageSigned(vin) {
      if (!vin) { alert('è¯¥è¡Œæ²¡æœ‰ VINï¼Œæ— æ³•ä¸Šä¼ å›¾ç‰‡'); return; }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;

      input.onchange = async () => {
        const files = input.files;
        if (!files || files.length === 0) return;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const filename = i === 0 ? `${vin}main` : `${vin}${i}`;
          const publicId = `${vin}/${filename}`;

          try {
            // å–ç­¾å
            const signRes = await fetch(`${BACKEND}/get-signature`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ public_id: publicId })
            });
            const { signature, timestamp, apiKey } = await signRes.json();

            const formData = new FormData();
            formData.append('file', file);
            formData.append('api_key', apiKey);
            formData.append('timestamp', timestamp);
            formData.append('signature', signature);
            formData.append('public_id', publicId);

            const uploadRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
              method: 'POST',
              body: formData
            });

            const result = await uploadRes.json();
            if (result.secure_url) {
              console.log('âœ… ä¸Šä¼ æˆåŠŸ:', result.secure_url);
            } else {
              console.error('âŒ ä¸Šä¼ å¤±è´¥:', result);
              alert('ä¸Šä¼ å¤±è´¥ï¼š' + (result.error?.message || 'æœªçŸ¥é”™è¯¯'));
            }
          } catch (err) {
            console.error('âŒ ä¸Šä¼ å¼‚å¸¸:', err);
            alert('ä¸Šä¼ å¼‚å¸¸ï¼š' + err.message);
          }
        }

        alert(`âœ… ä¸Šä¼ å®Œæˆï¼Œå…±ä¸Šä¼  ${files.length} å¼ å›¾`);
      };

      input.click();
    }

    // åˆæ¬¡åŠ è½½
    loadSheet();
  </script>
</body>
</html>
