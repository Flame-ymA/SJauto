<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>SJ Auto Inventory Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Tailwind CDN（开发/预览用） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { sjgold: '#FFD700' },
          boxShadow: {
            glow: '0 0 0 1px rgba(255,215,0,0.25), 0 10px 25px -5px rgba(0,0,0,0.5)'
          }
        }
      }
    }
  </script>
  <style>
    /* 固定 header 高度，方便 sticky 表头定位 */
    .app-header { height: 64px; }
  </style>
</head>
<body class="min-h-screen bg-black text-sjgold">

  <!-- 顶部栏（固定高度 64px） -->
  <header class="app-header sticky top-0 z-20 bg-zinc-950/80 backdrop-blur border-b border-sjgold/30">
    <div class="max-w-6xl mx-auto h-full px-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold tracking-wide">SJ Auto · Admin</h1>
      <div class="flex items-center gap-3">
        <!-- 查看卖车图片 -->
        <button onclick="window.location.href='admin-review.html'"
                class="px-4 py-2 rounded-xl border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition">
          查看卖车图片
        </button>
<button onclick="window.location.href='admin-rent.html'"
        class="px-4 py-2 rounded-xl border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition">
  管理租赁
</button>
        <!-- 选择并上传 Excel -->
        <label class="inline-flex items-center gap-3 px-3 py-2 rounded-xl border border-sjgold/30 hover:border-sjgold/60 transition">
          <input id="excelFile" type="file" class="hidden" />
          <span class="text-sm">选择 Excel</span>
        </label>
        <button onclick="uploadExcel()" class="px-4 py-2 rounded-xl bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90 shadow-glow transition">
          上传并加载表格
        </button>
      </div>
    </div>
  </header>

  <!-- 主体 -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="rounded-2xl border border-sjgold/30 bg-zinc-950/60 shadow-glow overflow-hidden">
      <div class="px-5 py-4 border-b border-sjgold/20 flex items-center justify-between">
        <h2 class="text-lg font-semibold">库存列表</h2>
        <span id="rowCount" class="text-xs text-sjgold/70"></span>
      </div>

      <!-- 可滚动容器 -->
      <div class="overflow-auto">
        <!-- 固定列宽：colgroup + table-fixed -->
        <table class="min-w-full text-sm table-fixed">
          <colgroup>
            <col style="width:5.5rem" />  <!-- Year -->
            <col style="width:6.5rem" />  <!-- Make -->
            <col style="width:8rem" />    <!-- Model -->
            <col style="width:8rem" />    <!-- Mileage -->
            <col style="width:9rem" />    <!-- Color -->
            <col style="width:8rem" />    <!-- Price -->
            <col style="width:8rem" />    <!-- Accident -->
            <col style="width:6rem" />    <!-- Status -->
            <col style="width:14rem" />   <!-- VIN -->
            <col style="width:12rem" />   <!-- 操作 -->
          </colgroup>

          <!-- sticky 表头：top 设为 header 的高度 64px -->
          <thead class="sticky top-0 z-10 bg-zinc-900 border-b border-sjgold/20">
            <tr class="text-left">
              <th class="px-4 py-3 font-semibold">Year</th>
              <th class="px-4 py-3 font-semibold">Make</th>
              <th class="px-4 py-3 font-semibold">Model</th>
              <th class="px-4 py-3 font-semibold">Mileage</th>
              <th class="px-4 py-3 font-semibold">Color</th>
              <th class="px-4 py-3 font-semibold">Price (CAD)</th>
              <th class="px-4 py-3 font-semibold">Accident</th>
              <th class="px-4 py-3 font-semibold">Status</th>
              <th class="px-4 py-3 font-semibold">VIN</th>
              <th class="px-4 py-3 font-semibold text-center">操作</th>
            </tr>
          </thead>

          <tbody id="tableBody" class="divide-y divide-sjgold/10">
            <!-- 行数据由 JS 注入 -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    // 加载表格（从后端 sheet1 读取）
    async function loadSheet() {
      try {
        const res = await fetch(`${BACKEND}/sheet1`);
        const data = await res.json();

        if (!data.ok) {
          console.error('Sheet1 读取失败：', data);
          alert('读取表格失败，稍后重试。');
          return;
        }

        const tbody = document.getElementById('tableBody');
        const count = document.getElementById('rowCount');
        tbody.innerHTML = '';

        const values = data.values || [];
        if (!values.length) {
          count.textContent = '共 0 条';
          return;
        }

        // 仅当第一行**看起来是表头**时，才跳过
        const first = values[0].map(v => String(v || '').trim().toLowerCase());
        const looksLikeHeader =
          first.includes('vin') ||
          first.includes('year') ||
          first.includes('make') ||
          first.includes('model');

        const rows = looksLikeHeader ? values.slice(1) : values;
        count.textContent = `共 ${rows.length} 条`;

        rows.forEach((row) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-zinc-900/60 transition';

          // 仅显示 0~8 列（不显示 Detail）
          const displayCols = [0,1,2,3,4,5,6,7,8];
          displayCols.forEach(colIndex => {
            const td = document.createElement('td');
            td.className = 'px-4 py-3 truncate';
            td.textContent = (row[colIndex] ?? '');
            tr.appendChild(td);
          });

          const vin = row[8] || '';
          const tdOps = document.createElement('td');
          tdOps.className = 'px-4 py-3';

          const wrap = document.createElement('div');
          wrap.className = 'flex justify-center gap-2';

          const uploadBtn = document.createElement('button');
          uploadBtn.className = 'w-24 px-3 py-1.5 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90 transition';
          uploadBtn.textContent = 'Upload';
          uploadBtn.onclick = () => uploadImageSigned(vin);
          wrap.appendChild(uploadBtn);

          const editBtn = document.createElement('button');
          editBtn.className = 'w-24 px-3 py-1.5 rounded-lg border border-sjgold/40 text-sjgold hover:bg-zinc-900 active:bg-zinc-800 transition';
          editBtn.textContent = '编辑描述';
          editBtn.onclick = () => window.open(`edit-description.html?vin=${encodeURIComponent(vin)}`, '_blank');
          wrap.appendChild(editBtn);

          tdOps.appendChild(wrap);
          tr.appendChild(tdOps);
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('读取表格失败：' + err.message);
      }
    }

    // 上传 Excel（后端增量写入）
    async function uploadExcel() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      if (!file) return alert('请先选择文件');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(`${BACKEND}/upload`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          console.error('上传失败：', data);
          alert('上传失败');
          return;
        }
        alert('上传成功');
        loadSheet();
      } catch (err) {
        console.error(err);
        alert('上传失败：' + err.message);
      }
    }

    // Cloudinary 签名上传：第一张 vinmain，其余 vin1、vin2…
    async function uploadImageSigned(vin) {
      if (!vin) { alert('该行没有 VIN，无法上传图片'); return; }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;

      input.onchange = async () => {
        const files = input.files;
        if (!files || files.length === 0) return;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const filename = i === 0 ? `${vin}main` : `${vin}${i}`;
          const publicId = `${vin}/${filename}`;

          try {
            // 取签名
            const signRes = await fetch(`${BACKEND}/get-signature`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ public_id: publicId })
            });
            const { signature, timestamp, apiKey } = await signRes.json();

            const formData = new FormData();
            formData.append('file', file);
            formData.append('api_key', apiKey);
            formData.append('timestamp', timestamp);
            formData.append('signature', signature);
            formData.append('public_id', publicId);

            const uploadRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
              method: 'POST',
              body: formData
            });

            const result = await uploadRes.json();
            if (result.secure_url) {
              console.log('✅ 上传成功:', result.secure_url);
            } else {
              console.error('❌ 上传失败:', result);
              alert('上传失败：' + (result.error?.message || '未知错误'));
            }
          } catch (err) {
            console.error('❌ 上传异常:', err);
            alert('上传异常：' + err.message);
          }
        }

        alert(`✅ 上传完成，共上传 ${files.length} 张图`);
      };

      input.click();
    }

    // 初次加载
    loadSheet();
  </script>
</body>
</html>
