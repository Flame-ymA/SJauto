<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Details - SJ Auto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- 基础安全（GitHub Pages 单文件版，含最小白名单） -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https:;
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline' https:;
                 script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
                 connect-src 'self' https://flameauto-write.onrender.com;
                 object-src 'none'; base-uri 'self'; frame-ancestors 'self'">
  <meta name="referrer" content="no-referrer"/>

  <!-- Tailwind（预览/开发用；生产建议改为本地构建） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { sjgold: '#FFD700' },
          boxShadow: {
            gold: '0 10px 25px -5px rgba(255,215,0,0.15), 0 8px 10px -6px rgba(255,215,0,0.08)'
          }
        }
      }
    }
  </script>

  <style>
    .btn-disabled { opacity:.5; pointer-events:none; }
  </style>
</head>
<body class="min-h-screen bg-black text-sjgold">
  <!-- 顶部条 -->
  <header class="sticky top-0 z-10 backdrop-blur bg-black/60 border-b border-sjgold/20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="text-sm md:text-base opacity-80 hover:opacity-100" rel="noopener noreferrer">← Back to Home</a>
      <div id="vinBadge" class="text-xs md:text-sm tracking-wider opacity-70"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 md:py-10">
    <!-- 左图右文 -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 md:gap-8 items-start">
      <!-- 图廊 -->
      <section class="md:col-span-3 w-full flex flex-col items-center">
        <div class="w-full md:w-[720px] h-[280px] sm:h-[360px] md:h-[480px]
                    bg-neutral-900/70 rounded-2xl ring-1 ring-sjgold/20
                    shadow-gold overflow-hidden flex items-center justify-center">
          <img id="carImage" alt="Vehicle Image"
               class="w-full h-full object-cover select-none"
               src="https://placehold.co/720x480/111111/FFD700?text=Loading..."
               decoding="async" loading="eager" referrerpolicy="no-referrer"/>
        </div>

        <!-- 导航按钮（胶囊样式，固定一行） -->
        <div class="mt-4 flex gap-3 justify-center">
          <button id="btnPrev" type="button"
                  class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full
                         bg-gradient-to-b from-yellow-400 to-yellow-500 text-black font-medium text-sm
                         shadow-[0_4px_14px_rgba(255,215,0,0.4)]
                         hover:shadow-[0_6px_20px_rgba(255,215,0,0.6)]
                         hover:brightness-105 active:scale-95 transition-all"
                  onclick="prevImage()">⬅️ <span>Previous</span></button>

          <button id="btnNext" type="button"
                  class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full
                         bg-gradient-to-b from-yellow-400 to-yellow-500 text-black font-medium text-sm
                         shadow-[0_4px_14px_rgba(255,215,0,0.4)]
                         hover:shadow-[0_6px_20px_rgba(255,215,0,0.6)]
                         hover:brightness-105 active:scale-95 transition-all"
                  onclick="nextImage()"><span>Next</span> ➡️</button>
        </div>

        <!-- 缩略图 -->
        <div id="thumbs" class="mt-5 grid grid-cols-6 gap-2 w-full md:w-[720px]"></div>
      </section>

      <!-- 描述 -->
      <aside class="md:col-span-2 w-full bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/15 shadow-gold p-5 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold mb-3">Vehicle Description</h2>
        <div id="descText" class="leading-relaxed text-sjgold/90">Loading...</div>
        <div id="report" class="mt-8 text-right"></div>
      </aside>
    </div>
  </main>

  <script>
    // ===== 配置（全部走你后端）=====
    const BACKEND = 'https://flameauto-write.onrender.com';
    const vin = new URLSearchParams(window.location.search).get('vin')?.trim();
    const vinBadge = document.getElementById('vinBadge');
    if (vin) vinBadge.textContent = `VIN: ${vin}`;

    let currentIndex = 0;
    let imageUrls = [];

    // Cloudinary 变换：把 /upload/ 替换为 /upload/{transforms}/
    function withTransform(url, transforms) {
      try {
        const u = new URL(url);
        return u.href.replace('/upload/', `/upload/${transforms}/`);
      } catch {
        return url;
      }
    }

    // 优先把 main 放首位
    function sortMainFirst(list) {
      const main = list.find(u => /main\./i.test(u));
      if (!main) return list;
      return [main, ...list.filter(u => u !== main)];
    }

    // 网络请求超时小工具
    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 12000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const resp = await fetch(resource, { ...options, signal: controller.signal });
        return resp;
      } finally {
        clearTimeout(id);
      }
    }

    // ====== 加载图片（后端 Cloudinary 搜索）======
    async function loadImages() {
      const imgEl = document.getElementById('carImage');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');

      if (!vin) {
        imgEl.src = 'https://placehold.co/720x480/111111/FFD700?text=No+VIN';
        btnPrev.classList.add('btn-disabled');
        btnNext.classList.add('btn-disabled');
        return;
      }

      try {
        const res = await fetchWithTimeout(`${BACKEND}/cloudinary-search?vin=${encodeURIComponent(vin)}`, { timeout: 15000 });
        if (!res.ok) throw new Error('cloudinary-search failed');
        const data = await res.json();

        const resources = Array.isArray(data.resources) ? data.resources : [];
        let urls = resources.map(r => r.secure_url).filter(Boolean);

        // 优先 main
        urls = sortMainFirst(urls);

        if (urls.length === 0) {
          imgEl.src = 'https://placehold.co/720x480/111111/FFD700?text=No+Image';
          btnPrev.classList.add('btn-disabled');
          btnNext.classList.add('btn-disabled');
          return;
        }

        // 固定清晰度与尺寸（主图 720×480）
        imageUrls = urls.map(u => withTransform(u, 'c_fill,w_720,h_480,q_auto,f_auto'));
        currentIndex = 0;
        imgEl.src = imageUrls[0];
        btnPrev.classList.remove('btn-disabled');
        btnNext.classList.remove('btn-disabled');
        renderThumbs(urls);
      } catch (e) {
        console.error(e);
        imgEl.src = 'https://placehold.co/720x480/111111/FFD700?text=Error';
        document.getElementById('btnPrev').classList.add('btn-disabled');
        document.getElementById('btnNext').classList.add('btn-disabled');
      }
    }

    // ====== 缩略图（固定 240×160）======
    function renderThumbs(rawUrls) {
      const wrap = document.getElementById('thumbs');
      wrap.innerHTML = '';
      const thumbs = rawUrls.map(u => withTransform(u, 'c_fill,w_240,h_160,q_auto,f_auto'));

      thumbs.forEach((url, idx) => {
        const btn = document.createElement('button');
        btn.className =
          'relative aspect-[3/2] w-full overflow-hidden rounded-lg ring-1 ring-sjgold/20 hover:ring-sjgold/40 transition';
        const img = document.createElement('img');
        img.src = url;
        img.alt = `thumb ${idx+1}`;
        img.className = 'w-full h-full object-cover';
        img.referrerPolicy = 'no-referrer';
        btn.onclick = () => {
          currentIndex = idx;
          document.getElementById('carImage').src = imageUrls[idx]; // 用大图尺寸版本
        };
        btn.appendChild(img);
        wrap.appendChild(btn);
      });
    }

    function nextImage() {
      if (!imageUrls.length) return;
      currentIndex = (currentIndex + 1) % imageUrls.length;
      document.getElementById('carImage').src = imageUrls[currentIndex];
    }

    function prevImage() {
      if (!imageUrls.length) return;
      currentIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
      document.getElementById('carImage').src = imageUrls[currentIndex];
    }

    // ====== 加载描述（后端代理，不暴露 API Key）======
    async function loadDescription() {
      const descEl = document.getElementById('descText');
      if (!vin) { descEl.textContent = 'Vehicle not found'; return; }

      try {
        const res = await fetchWithTimeout(`${BACKEND}/sheet1/detail?vin=${encodeURIComponent(vin)}`, { timeout: 12000 });
        if (!res.ok) throw new Error('sheet1/detail failed');
        const data = await res.json();
        const text = (data && typeof data.detail === 'string') ? data.detail : '';
        descEl.textContent = text || 'No description available.';
      } catch (err) {
        console.error('Failed to load description:', err);
        descEl.textContent = 'No description available.';
      }
    }

    // 启动
    loadImages();
    loadDescription();
  </script>
</body>
</html>
